name: Build ARM64 Kernel

permissions:
  contents: write
  actions: read

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt build-dep linux || sudo apt install -y \
            build-essential bc bison flex \
            libssl-dev libncurses-dev \
            libelf-dev cpio kmod rsync
          sudo apt install llvm clang lld procps zstd tar -y
      
      - name: Download and configure kernel
        run: |
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.19.tar.xz
          tar xf linux-6.19.tar.xz
          cd linux-6.19
          wget https://raw.githubusercontent.com/290Tester/build-linux/refs/heads/main/config-6.12.63+deb13-arm64 -O .config
          wget https://raw.githubusercontent.com/290Tester/build-linux/refs/heads/main/mkcompile_h -O scripts/mkcompile_h
          chmod +x+w+r scripts/mkcompile_h
          export LLVM="1"
          echo 'CONFIG_LOCALVERSION="-Zako-Neko"' >> .config
          make olddefconfig || (wget -O .config https://raw.githubusercontent.com/290Tester/build-linux/refs/heads/main/config-6.12.63+deb13-arm64 && echo 'CONFIG_LOCALVERSION="-Zako-Neko"' >> .config && make olddefconfig)
          
          echo "KERNEL_SRC=$(pwd)" >> $GITHUB_ENV
      
      - name: TestCPU-RAM
        run: |
          cat /proc/cpuinfo
          free
      
      - name: Build kernel
        run: |
          export KBUILD_BUILD_TIMESTAMP="1970-01-01 00:00:00" KBUILD_BUILD_USER="root" KBUILD_BUILD_HOST="Murasame" KBUILD_BUILD_VERSION="1" LLVM="1"
          cd $KERNEL_SRC
          make KBUILD_BUILD_TIMESTAMP="1970-01-01 00:00:00" KBUILD_BUILD_USER="root" KBUILD_BUILD_HOST="Murasame" KBUILD_BUILD_VERSION="1" LLVM="1" -j$(nproc)
      
      - name: Get kernel version
        id: get_version
        run: |
          cd $KERNEL_SRC
          VERSION=$(make kernelversion)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "full_version=${VERSION}-Segfault" >> $GITHUB_OUTPUT
      
      - name: Package kernel
        run: |
          cd $KERNEL_SRC
          tar -cf - . | zstd --ultra -22 -T0 --long -o $GITHUB_WORKSPACE/linux-${{ steps.get_version.outputs.version }}-segfault-neox-arm64-full.tar.zst
      
      - name: Upload artifact (for CI debug)
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ steps.get_version.outputs.version }}
          path: linux-${{ steps.get_version.outputs.version }}-segfault-neox-arm64-full.tar.zst
          compression-level: 0

      - name: Upload to Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: linux-${{ steps.get_version.outputs.version }}-segfault-neox-arm64-full.tar.zst
          tag_name: v${{ steps.get_version.outputs.version }}-segfault-${{ github.run_number }}-${{ github.sha }}
          name: "Kernel ${{ steps.get_version.outputs.full_version }}-neox ARM64"
          body: |
            完整源码树构建产物 (Linux 6.19)
            - 压缩: zstd --ultra -22 -T0 --long
            - 架构: ARM64
            - 版本: ${{ steps.get_version.outputs.full_version }}-neox
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}