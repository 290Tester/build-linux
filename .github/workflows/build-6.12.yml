name: Build ARM64 Kernel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt build-dep linux || sudo apt install -y \
            build-essential bc bison flex \
            libssl-dev libncurses-dev \
            libelf-dev cpio kmod rsync
          sudo apt install llvm clang lld procps
      
      - name: Download and configure kernel
        run: |
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.12.71.tar.xz
          tar xf linux-6.12.71.tar.xz
          
          cd linux-6.12.71
          
          wget https://raw.githubusercontent.com/290Tester/build-linux/refs/heads/main/config-6.12.63+deb13-arm64 -O .config
          wget wget https://raw.githubusercontent.com/290Tester/build-linux/refs/heads/main/mkcompile_h -O scripts/mkcompile_h
          chmod +x+w+r scripts/mkcompile_h
          export KBUILD_BUILD_USER="root"
          export KBUILD_BUILD_HOST="NeoX-北北"
          export LLVM="1"
          echo 'CONFIG_LOCALVERSION="-Segfault北北"' >> .config
          echo 'KBUILD_BUILD_USER="root"' >> .config
          echo 'KBUILD_BUILD_HOST="NeoX-北北"' >> .config
          echo 'KBUILD_BUILD_TIMESTAMP="1970-01-01 00:00:00"' >> .config
          echo 'KBUILD_BUILD_VERSION="1"' >> .config
          make olddefconfig || (wget -O .config https://raw.githubusercontent.com/290Tester/build-linux/refs/heads/main/config-6.12.63+deb13-arm64 && echo 'CONFIG_LOCALVERSION="-Segfault北北"' >> .config && make olddefconfig)
          
          echo "KERNEL_SRC=$(pwd)" >> $GITHUB_ENV
      
      - name: TestCPU-RAM
        run: |
          cat /proc/cpuinfo
          free
      - name: Build kernel
        run: |
          export KBUILD_BUILD_TIMESTAMP="1970-01-01 00:00:00" KBUILD_BUILD_USER="root" KBUILD_BUILD_HOST="NeoX-北北" KBUILD_BUILD_VERSION="1" LLVM="1"
          cd $KERNEL_SRC
          make KBUILD_BUILD_TIMESTAMP="1970-01-01 00:00:00" KBUILD_BUILD_USER="root" KBUILD_BUILD_HOST="NeoX-北北" KBUILD_BUILD_VERSION="1" LLVM="1" -j$(nproc)
      
      - name: Get kernel version
        id: get_version
        run: |
          cd $KERNEL_SRC
          VERSION=$(make kernelversion)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "full_version=${VERSION}-Segfault" >> $GITHUB_OUTPUT
      
      - name: Package kernel
        run: |
          cd $KERNEL_SRC
          mkdir -p output
          cp arch/arm64/boot/Image output/
          cp .config output/config
          find arch/arm64/boot/dts -name "*.dtb" -exec cp {} output/ \;
          
          tar -czf ../kernel-${{ steps.get_version.outputs.full_version }}.tar.gz output/
          
          if [ -d modules ]; then
            tar -czf ../modules-${{ steps.get_version.outputs.full_version }}.tar.gz modules/
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-6.12
          path: |
            kernel-*.tar.gz
            modules-*.tar.gz
            